#!/bin/bash

#------------------------------------------------------------------------------
# Define default values:
#------------------------------------------------------------------------------

: "${KV_TYPE:=etcd}"
: "${KV_IP:=127.0.0.1}"
: "${KV_PORT:=2379}"
: "${KV_PATH:=/mesos/dns}"
: "${KV_TTL:=30}"
: "${KV_PUSH_INTERVAL:=$((${KV_TTL}/2))}"


#------------------------------------------------------------------------------
# Functions:
#------------------------------------------------------------------------------

function dns_alive() {
  timeout -t 2 echo > /dev/tcp/127.0.0.1/${MDNS_PORT} \
  &> /dev/null && return 0 || return 1
}

#------------------------------------------------------------------------------
# Main loop:
#------------------------------------------------------------------------------

sleep 3; while true; do

  dns_alive && {

    # Publish the service:
    kviator --kvstore=${KV_TYPE} --client=${KV_IP}:${KV_PORT} put \
    ${KV_PATH}/$(hostname) "nameserver $(hostname -i)"

    # Set expiration TTL (only etcd):
    [ "${KV_TYPE}" == "etcd" ] && \
    curl -sL http://${KV_IP}:${KV_PORT}/v2/keys${KV_PATH}/$(hostname) \
    -XPUT -d value="nameserver $(hostname -i)" -d ttl=${KV_TTL} -d prevExist=true
  }

  sleep ${KV_PUSH_INTERVAL}

done
