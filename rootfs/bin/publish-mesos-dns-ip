#!/bin/bash

#------------------------------------------------------------------------------
# Define default values:
#------------------------------------------------------------------------------

: "${KV_TYPE:=etcd}"
: "${KV_IP:=127.0.0.1}"
: "${KV_PORT:=2379}"
: "${KV_PATH:=/mesos/dns}"

#------------------------------------------------------------------------------
# Functions:
#------------------------------------------------------------------------------

function dns_alive() {

  # Test DNS service:
  timeout -t 2 bash -c "echo > /dev/tcp/127.0.0.1/${MDNS_PORT}" &> /dev/null && {

    # Publish the service:
    kviator --kvstore=${KV_TYPE} --client=${KV_IP}:${KV_PORT} put \
    ${KV_PATH}/$(hostname) "nameserver $(hostname -i)"; return 0

  } || return 1
}

#------------------------------------------------------------------------------
# Main loop:
#------------------------------------------------------------------------------

while true; do
  dns_alive && echo "$(date) alive" || echo "$(date) dead"
  sleep 1
done
