#!/bin/bash

#------------------------------------------------------------------------------
# Define default values:
#------------------------------------------------------------------------------

: "${KV_TYPE:=etcd}"
: "${KV_IP:=127.0.0.1}"
: "${KV_PORT:=2379}"
: "${KV_PATH:=/mesos/dns}"

#------------------------------------------------------------------------------
# Functions:
#------------------------------------------------------------------------------

function dns_alive() {
  timeout -t 2 bash -c "echo > /dev/tcp/127.0.0.1/${MDNS_PORT}" \
  &> /dev/null && return 0 || return 1
}

#------------------------------------------------------------------------------
# Main loop:
#------------------------------------------------------------------------------

while true; do

  dns_alive && {
    kviator --kvstore=${KV_TYPE} --client=${KV_IP}:${KV_PORT} put \
    ${KV_PATH}/$(hostname) "nameserver $(hostname -i)"
  }

  sleep 60

done
